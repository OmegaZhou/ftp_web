<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <style>

    </style>
    <script>
        var now_dir;
        function createPath(result) {
            now_dir = result;
            var items = result.split('/');
            var path = $('#now_dir');
            path.empty();
            var path_str;
            var split_flag = $('<span>/</span>');
            path.append(split_flag)
            path_str = '/';
            if (now_dir != "/") {
                for (var i = 1; i < items.length; ++i) {
                    path_str += items[i] + '/';
                    var item = $('<span></span>');
                    var url = $('<a></a>');
                    url.text(items[i]);
                    url.attr('href', 'javascript:void(0)');
                    url.attr('onclick', 'changeDir("' + path_str + '")');
                    item.append(url);
                    split_flag = $('<span>/</span>');
                    item.append(split_flag);
                    path.append(item);
                }
            }
        }
        function ajax_get(url, callback) {
            $.get('/ftp/api/' + url, result => {
                if (result.message != 'success') {
                    location.href = '/ftp/login.html'
                } else {
                    callback(result.result)
                }
            })
        }
        function ajax_post(url, para, callback) {
            $.post('/ftp/api/' + url, para, result => {
                if (result.message != 'success') {
                    location.href = '/ftp/login.html'
                } else {
                    callback(result.result)
                }
            })
        }
        function get_dir() {
            ajax_get('get_dir', result => {
                $('#dir').empty();
                for (var i = 0; i < result.length; ++i) {
                    var li = $('<li class="list-group-item"></li>');
                    var item = $('<div></div>')
                    item.attr('style', "height:40px")
                    var img = $('<img/>');
                    var link = $('<a></a>');

                    
                    img.attr('height', '30px');
                    img.attr('width', '30px');

                    link.text(result[i].name);

                    item.append(img);
                    item.append(link);
                    li.append(item)

                    if (result[i].type == 'd') {
                        img.attr('src', '/ftp/img/folder.png');
                        link.attr('href', 'javascript:void(0)')
                        link.attr('onclick', 'changeDir("' + now_dir + result[i].name + '")');
                    } else {
                        img.attr('src', '/ftp/img/file.png');
                        var download_link=$("<a></a>")
                        download_link.attr("download",result[i].name)
                        var para=now_dir+result[i].name;
				        para=encodeURIComponent(para.toString());
                        download_link.attr('href','/ftp/api/download/'+para)
                        var download_bin=$('<button class="btn-xs">下载</button>')
                        download_link.append(download_bin);
                        item.append(download_link)
                    }
                    
                    $('#dir').append(li);
                }
            })
        }
        function pwd() {
            ajax_get('pwd', result => {
                console.log(result);
                createPath(result);
            })
        }
        function changeDir(path) {
            ajax_post('change_dir', { path: path }, result => {
                pwd();
                get_dir();
            })
        }
    </script>

</head>

<body>
    <div
        style="background:url('img/login.jpg') no-repeat;background-size:cover; position: absolute; width:100%; height: 100%;">
        <div class="container" style="width: 50%; background-color: azure">
            <div>
                <a href="javascript:void(0)" onclick="changeDir('/')">回到根目录</a>
                <span>&emsp;&emsp;当前目录:</span>
                <span id="now_dir"></span>
            </div>
            <ul class="list-group" id="dir">

            </ul>
        </div>



    </div>
    <script>
        $(document).ready(function () {
            pwd();
            get_dir();
        })
    </script>
</body>
