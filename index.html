<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <style>

    </style>
    <script>
        var now_dir;
        function createPath(result) {
            now_dir = result;
            var items = result.split('/');
            var path = $('#now_dir');
            path.empty();
            var path_str;
            var split_flag = $('<span>/</span>');
            path.append(split_flag)
            path_str = '/';
            if (now_dir != "/") {
                for (var i = 1; i < items.length; ++i) {
                    path_str += items[i] + '/';
                    var item = $('<span></span>');
                    var url = $('<a></a>');
                    url.text(items[i]);
                    url.attr('href', 'javascript:void(0)');
                    url.attr('onclick', 'changeDir("' + path_str + '")');
                    item.append(url);
                    split_flag = $('<span>/</span>');
                    item.append(split_flag);
                    path.append(item);
                }
            }
        }
        function ajax_get(url, callback) {
            $.get('/ftp/api/' + url, result => {
                if (result.message != 'success') {
                    location.href = '/ftp/login.html'
                } else {
                    callback(result.result)
                }
            })
        }
        function ajax_post(url, para, callback) {
            $.post('/ftp/api/' + url, para, result => {
                if (result.message != 'success') {
                    location.href = '/ftp/login.html'
                } else {
                    callback(result.result)
                }
            })
        }
        function get_dir() {
            ajax_get('get_dir', result => {
                $('#dir').empty();
                for (var i = 0; i < result.length; ++i) {
                    var li = $('<li class="list-group-item"></li>');
                    var item = $('<div class="row"></div>')
                    item.attr('style', "height:40px")
                    var img = $('<img/>');
                    var link = $('<a></a>');
                    var file_box = $('<div class="col-md-8 col-xs-8"></div>')
                    var bin_box = $('<div class="col-md-4 col-xs-4"></div>')
                    img.attr('height', '30px');
                    img.attr('width', '30px');

                    link.text(result[i].name);
                    file_box.append(img);
                    file_box.append(link);
                    item.append(file_box);
                    li.append(item)

                    if (result[i].type == 'd') {
                        img.attr('src', '/ftp/img/folder.png');
                        link.attr('href', 'javascript:void(0)')
                        link.attr('onclick', 'changeDir("' + now_dir + result[i].name + '")');
                    } else {


                        img.attr('src', '/ftp/img/file.png');
                        var download_link = $("<a></a>")
                        download_link.attr("download", result[i].name)
                        var para = now_dir + result[i].name;
                        para = encodeURIComponent(para.toString());
                        download_link.attr('href', '/ftp/api/download/' + para)
                        var download_bin = $('<button class="btn-xs">下载</button>')
                        download_link.append(download_bin);
                        bin_box.append(download_link)
                    }
                    item.append(bin_box);
                    $('#dir').append(li);
                }
            })
        }
        function pwd() {
            ajax_get('pwd', result => {
                get_dir();
                createPath(result);
            })
        }
        function changeDir(path) {
            ajax_post('change_dir', { path: path }, result => {
                pwd();
            })
        }

        function logout(){
            ajax_get('logout',result=>{
                location.href="/ftp/login.html"
            })
        }
    </script>

</head>

<body>
    <div
        style="background:url('img/login.jpg') no-repeat;background-size:cover; position: absolute; width:100%; height: 100%;">
        <div class="container" style="width: 60%; background-color: azure">
            <div id="button_box">
                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#mkdir">新建文件夹</button>
                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#upload">上传文件</button>
                <button class="btn btn-primary btn-sm" onclick="logout()">登出</button>
            </div>
            <div>
                <a href="javascript:void(0)" onclick="changeDir('/')">回到根目录</a>
                <span>&emsp;&emsp;当前目录:</span>
                <span id="now_dir"></span>
            </div>
            <ul class="list-group" id="dir">
            </ul>


            <div id="mkdir" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">新建文件夹</h4>
                        </div>
                        <input type="text" id="folder_name" placeholder="输入新创建的文件夹名字"/>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary">新建</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal -->
            </div>

            <div id="upload" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">上传文件</h4>
                        </div>
                        <input type="file" id="upload_file"/>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary">上传</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal -->
            </div>
        </div>



    </div>
    <script>
        $(document).ready(function () {
            pwd();
        })
    </script>
</body>